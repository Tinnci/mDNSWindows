name: Unit Tests

on:
  push:
    branches: [ main, "feature/**", "win/**" ]
    paths:
      - 'mDNSWindows/**'
      - 'mDNSCore/**'
      - 'mDNSShared/**'
      - 'unittests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/unit-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'mDNSWindows/**'
      - 'mDNSCore/**'
      - 'mDNSShared/**'
      - 'unittests/**'
      - 'CMakeLists.txt'
      - '.github/workflows/unit-tests.yml'

jobs:
  test:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [Win32, x64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.0'
    
    - name: Create build directory
      run: mkdir build_test_${{ matrix.arch }}
      shell: pwsh
    
    - name: Configure CMake with tests
      run: |
        cd build_test_${{ matrix.arch }}
        cmake -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTING=ON ..
      shell: pwsh
    
    - name: Build tests
      run: |
        cd build_test_${{ matrix.arch }}
        cmake --build . --config Debug --parallel 4 --target unittest
      shell: pwsh
      continue-on-error: true
    
    - name: Run tests
      run: |
        cd build_test_${{ matrix.arch }}
        ctest --build-config Debug --verbose
      shell: pwsh
      continue-on-error: true
