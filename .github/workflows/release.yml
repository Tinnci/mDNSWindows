name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-release:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [Win32, x64]
        config: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.0'
    
    - name: Create build directory
      run: mkdir build_${{ matrix.arch }}
      shell: pwsh
    
    - name: Configure CMake
      run: |
        cd build_${{ matrix.arch }}
        cmake -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=${{ matrix.config }} -DCMAKE_INSTALL_PREFIX=install ..
      shell: pwsh
    
    - name: Build
      run: |
        cd build_${{ matrix.arch }}
        cmake --build . --config ${{ matrix.config }} --parallel 4
      shell: pwsh
    
    - name: Install
      run: |
        cd build_${{ matrix.arch }}
        cmake --install . --config ${{ matrix.config }}
      shell: pwsh
    
    - name: Create artifact
      run: |
        $archName = "${{ matrix.arch }}"
        $configName = "${{ matrix.config }}"
        $zipName = "mdnswindows-${archName}-${configName}.zip"
        
        # Create zip with build outputs
        Compress-Archive -Path "build_${{ matrix.arch }}/install/*" -DestinationPath $zipName -Force
        
        Write-Host "Created artifact: $zipName"
      shell: pwsh
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mdnswindows-${{ matrix.arch }}-${{ matrix.config }}
        path: mdnswindows-${{ matrix.arch }}-${{ matrix.config }}.zip
        retention-days: 30
  
  create-release:
    needs: build-release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts
    
    - name: Get tag information
      id: tag
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "version=${TAG#v}" >> $GITHUB_OUTPUT
    
    - name: Generate changelog
      id: changelog
      run: |
        PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.tag.outputs.tag }}^ 2>/dev/null || echo "")
        if [ -z "$PREV_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${{ steps.tag.outputs.tag }})
        else
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..${{ steps.tag.outputs.tag }})
        fi
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release with Artifacts
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Release ${{ steps.tag.outputs.version }}
        body: |
          ## Version ${{ steps.tag.outputs.version }}

          ### Changes
          ${{ steps.changelog.outputs.changelog }}

          ### Build Artifacts
          Complete builds for all supported architectures and configurations.
          
          **Supported Architectures:**
          - Windows x86 (Win32)
          - Windows x64
          
          **Configurations:**
          - Debug
          - Release
          
          Each build includes:
          - DNS-SD client libraries (dnssd.dll)
          - Header files
          - Helper libraries and utilities
        files: release-artifacts/**/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

